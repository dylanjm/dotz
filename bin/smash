#!/usr/bin/env bash

setup-vars() {
  [[ -e /tmp/office_space.jpg ]] && rm /tmp/office_space.jpg
  [[ -e /tmp/smash.jpg ]] && rm /tmp/smash.jpg

  IMG_URL="https://electricbricks.net/wp-content/uploads/2016/11/office-space-printer.jpg"
  MEME_FILE=$(mktemp /tmp/smash.jpg)
  OFFICE_SPACE=$(mktemp /tmp/office_space.jpg)
  wget --quiet "${IMG_URL}" -O "${OFFICE_SPACE}"
}

parse-args() {
  while getopts ":w" flag; do
    case "$flag" in
      w)
        WHITEBAR=1
        ;;
      :)
        printf "Invalid Flag"
        exit 1
        ;;
      \?)
        printf "Usage: smash [-w] MEME_TEXT"
        exit 1
        ;;
    esac
  done
}

make_meme() {
  local caption="${1}"

  if [[ "${WHITEBAR}" = "1" ]]; then
    convert "${OFFICE_SPACE}" \
            -background white \
            -fill black \
            -size ${width}x100 \
            label:"${caption}" \
            +swap \
            -gravity West \
            -append "${MEME_FILE}"
  else
    convert "${OFFICE_SPACE}" \
            -pointsize 72 \
            -annotate +750+1100 \
            "${caption}" \
            "${MEME_FILE}"
  fi

}

file-to-clipboard() {
  osascript \
    -e 'on run args' \
    -e 'set the clipboard to (read (POSIX file (first item of args)) as JPEG picture)' \
    -e end \
    "${MEME_FILE}"
}


main() {
    parse-args "${@}"
    shift $((OPTIND - 1))
    setup-vars
    make_meme "${1}"
    file-to-clipboard
}

main "${@}"
