#!/usr/bin/env bash

readonly PROGNAME="$(basename "${0}")"
readonly ARGS=("${@}")

readonly NORMAL='\033[0m'
readonly RED='\033[1;31m'
readonly GREEN='\033[1;32m'
readonly BLUE='\033[1;34m'
readonly YELLOW='\033[1;33m'

yellow() { echo "${YELLOW}$*${NORMAL}"; }
green() { echo "${GREEN}$*${NORMAL}"; }
blue() { echo "${BLUE}$*${NORMAL}"; }
red() { echo "${RED}$*${NORMAL}"; }
magenta() { echo "${MAGENTA}$*${NORMAL}"; }
bold() { echo "${BOLD}$*${NORMAL}"; }

usage() {
    cat <<- EOF
$(echo -e "$(red "
                      _     _
   __ _ ___ ___  ___ | |__ (_)
  / _' / __/ __|/ _ \| '_ \| |
 | (_| \__ \__ \ (_) | |_) | |
  \__,_|___/___/\___/|_.__// |
                         |__/
")")

$(echo -e "$(blue "ASS")")essment $(echo -e "$(blue "OBJ")")ects:

Script that maps assessment test objects to respective input file names.

$(echo -e "$(green "USAGE")"):
       ${PROGNAME} [-h]

$(echo -e "$(green "OPTIONS")"):
       -h  Display this help information.

EOF
}

get_args() {
    while getopts ":h" flag; do
        case "$flag" in
        h)
            usage
            exit 0
            ;;
        \?)
            usage
            exit 1
            ;;
        esac
    done
}

get_cons_obs() {
    local line="${1}"
    "$HOME/Documents/projects/bison/bison-opt" -i "${line}" --list-constructed-objects --no-gdb-backtrace 2>&1 \
        | awk '/^\*\*\* ERROR \*\*\*/{print "ERROR"; exit}'\
              '/^\*\*START OBJECT DATA\*\*$/{flag=1;next}'\
              '/^\*\*END OBJECT DATA\*\*$/{flag=0} flag' \
        | xargs printf "${line},%s\n"
}
export -f get_cons_obs

get_input_files() {
    local files
    mapfile -t files < <(fd -e i . "$HOME/Documents/projects/bison/assessment/LWR" --exec printf "%s\n" "{}";)

    parallel -j28 get_cons_obs ::: "${files[@]}"
}

main() {

    get_args "${ARGS[@]}"

    get_input_files
}

main "${ARGS[@]}"
